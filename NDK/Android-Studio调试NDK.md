记得之前做饮料售卖机的支付模块
笔者用的jni下串口通信，那个时候没有用调试(主要不知道怎么调试底层)，只得打出日志分析，非常痛苦，不过项目经历也令人难忘，成长不少。

最近发现Android Studio对NDK的调试支持越来越好了，在网上整理了很多经验帖，重走一遍，记录一下
新建项目NDKCode
新建文件cn.byhook.lib.LibCode.java
```
public class LibCode {

    static {
        System.loadLibrary("code");
    }

    public native String getMessage();
}

```
用javah生成对应的头文件LibCode.h
或者自定义菜单External Tools生成
```
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class cn_byhook_lib_LibCode */

#ifndef _Included_cn_byhook_lib_LibCode
#define _Included_cn_byhook_lib_LibCode
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     cn_byhook_lib_LibCode
 * Method:    get
 * Signature: ()V
 */
JNIEXPORT jstring JNICALL Java_cn_byhook_lib_LibCode_getMessage
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```
对应的源文件
```
#include "LibCode.h"

JNIEXPORT jstring JNICALL Java_cn_byhook_lib_LibCode_getMessage
  (JNIEnv * env, jobject thiz)
{
    int vCode = 10;
    return (*env)->NewStringUTF(env, "Message ...");
}
```
目录结构
![](http://upload-images.jianshu.io/upload_images/2006464-6abdb990ba087ac6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

在根目录下的build.gradle中添加
```
classpath 'com.android.tools.build:gradle-experimental:0.7.0'
```
如图所示
![](http://upload-images.jianshu.io/upload_images/2006464-e5c4bf172afe9e47.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

对应的gradle版本

![](http://upload-images.jianshu.io/upload_images/2006464-bba0e6d5a7e18b97.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

而Module中的build.gradle配置
首先将
```
apply plugin: 'com.android.application'
```
改为
```
apply plugin: 'com.android.model.application'
```
在android外层加上model
如下
```
model {

    android {
        compileSdkVersion 23
        buildToolsVersion "23.0.3"

        defaultConfig {
            applicationId "cn.byhook.ndkcode"
            minSdkVersion.apiLevel = 10
            targetSdkVersion.apiLevel = 23
        }

        ndk {
            moduleName = 'code'
            toolchain = 'clang'
            CFlags.addAll(['-Wall'])
        }

        buildTypes {
            release {
                minifyEnabled false
                proguardFiles.add(file("proguard-rules.pro"))
            }
        }

        productFlavors {
            create("arm") {
                ndk.abiFilters.add("armeabi")
            }
            create("arm7") {
                ndk.abiFilters.add("armeabi-v7a")
            }
            create("arm8") {
                ndk.abiFilters.add("arm64-v8a")
            }
            create("x86") {
                ndk.abiFilters.add("x86")
            }
            create("x86-64") {
                ndk.abiFilters.add("x86_64")
            }
            create("mips") {
                ndk.abiFilters.add("mips")
            }
            create("mips-64") {
                ndk.abiFilters.add("mips64")
            }
            create("all")
        }
    }
}
```
注意要去掉原有的
```
minSdkVersion 9
targetSdkVersion 22
```
改为
```
minSdkVersion.apiLevel = 10
targetSdkVersion.apiLevel = 23
```
moduleName填写你要生成的模块名称

配置调试器

![](http://upload-images.jianshu.io/upload_images/2006464-209b560913baa87c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

![](http://upload-images.jianshu.io/upload_images/2006464-bb07ce540bc921be.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


![](http://upload-images.jianshu.io/upload_images/2006464-5652caa331e0ee04.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

如果报错
点击Fix，安装好LLDB，然后点击OK即可

MainActivity中调用
```
public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        final LibCode mLibCode = new LibCode();
        Toast.makeText(this, "" + mLibCode.getMessage(), Toast.LENGTH_SHORT).show();
    }
}
```

接下来，如图所示打上断点

![](http://upload-images.jianshu.io/upload_images/2006464-fbb4cf5fb9c739e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

选中NDK-Debug配置
调试起来

![](http://upload-images.jianshu.io/upload_images/2006464-2602f0b02245f7c4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

现在已经非常方便了

本开源库地址
https://github.com/byhook/NDKCode

参考
官方文档
http://tools.android.com/tech-docs/new-build-system/gradle-experimental
官方开源库集成Gradle Experimental Android plugin
https://github.com/googlesamples/android-ndk
zzyyppqq
http://www.jianshu.com/p/7844aafe897d
